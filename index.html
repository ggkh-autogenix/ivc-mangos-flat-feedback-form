<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sindhura Mango Feedback</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #fff8ef;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    header {
      background-color: #ffd369;
      padding: 20px;
      text-align: center;
      border-radius: 0 0 20px 20px;
    }
    header h1 {
      margin: 0;
      color: #222;
    }
    .intro, .feedback-section, .payment-section {
      background: white;
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    h2 {
      margin-top: 0;
    }
    input, textarea, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #04aa6d;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #038f5e;
    }
    #status, #orderStatus, #confirmStatus {
      font-weight: bold;
      margin-top: 10px;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <header>
    <h1>üçã Sindhura Mangoes ‚Äì A Taste of Tradition</h1>
  </header>
  <div class="container">
    <div class="intro">
      <p>This weekend, we shared the rich flavor of <strong>tree-ripened Sindhura mangoes</strong> ‚Äî naturally sweet, 100% pure, and chemical-free!</p>
      <p>üå≥ Grown in the fertile lands of <em>Palamaner Mandal, Chittoor District (Andhra Pradesh)</em>, these mangoes are ripened 85% on the tree for that signature juicy texture, vibrant red-yellow skin, and sweet-tangy taste.</p>
      <p><strong>The IVC family alone ordered over 100 KGs!</strong></p>
      <p>We hope you‚Äôve tasted and enjoyed them as much as we enjoyed delivering them to you. üôè</p>
      <p><strong>Please take a moment to share your feedback ‚Äî it means a lot to us!</strong></p>
    </div>

    <div class="feedback-section">
      <h2>üìù Share Your Feedback</h2>
      <input type="text" id="block" placeholder="Block" required />
      <input type="text" id="flat" placeholder="Flat Number" required />
      <textarea id="feedback" placeholder="Your Feedback" required></textarea>
      <button onclick="submitFeedback()">Submit Feedback</button>
      <p id="status"></p>
    </div>

    <div class="payment-section">
      <h2>üí∞ Make a Payment</h2>
      <label for="blockPay">Select Block</label>
      <input type="text" id="blockPay" placeholder="Block (e.g., A)" />
      <label for="flatPay">Select Flat Number</label>
      <input type="text" id="flatPay" placeholder="Flat Number (e.g., 101)" />
      <button onclick="calculatePayment()">Check Due Amount</button>
      <p id="orderStatus"></p>
      <p id="paymentNote" style="display:none; margin-top: 10px; font-style: italic;">üôè If you loved the mangoes, we'd be grateful for your support. You can make the payment below!</p>
      <div id="payButton" style="display: none;">
        <a id="gpayLink" href="#" onclick="launchGPay(event)" style="text-decoration: none;">
          <button style="background-color: #4285F4;">Pay Now via Google Pay</button>
        </a>
        <br/>
        <a id="phonepeLink" href="#" onclick="launchPhonePe(event)" style="text-decoration: none;">
          <button id="phonepeBtn" style="background-color: #5e35b1; margin-top: 10px;">Pay via PhonePe</button>
        </a>
        <br/>
        <button onclick="confirmPayment()" style="margin-top: 10px; background-color: #04aa6d;">‚úÖ I Have Made the Payment</button>
        <p id="confirmStatus"></p>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://mqslfvseexirbrsxpuws.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xc2xmdnNlZXhpcmJyc3hwdXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDI4OTEsImV4cCI6MjA2NjMxODg5MX0.bSPcphsl_YOtv3_z07AjU-3BX6wiueW5_xan5KR2f-U";

    let amount = 0, kgs = 0, block = '', flat = '';

    async function calculatePayment() {
      block = document.getElementById("blockPay").value.trim();
      flat = document.getElementById("flatPay").value.trim();
      const orderStatus = document.getElementById("orderStatus");
      const payButton = document.getElementById("payButton");

      if (!block || !flat) {
        orderStatus.innerText = "‚ùå Please select both Block and Flat Number.";
        orderStatus.className = "error";
        payButton.style.display = "none";
        return;
      }

      const url = `${SUPABASE_URL}/rest/v1/orderInfo?block=eq.${block}&flat=eq.${flat}&select=kgs`;

      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`
        }
      });

      const data = await res.json();
      if (data.length === 0 || !data[0].kgs) {
        orderStatus.innerText = "‚ùå No mango order found for this flat.";
        orderStatus.className = "error";
        payButton.style.display = "none";
        return;
      }

      kgs = data[0].kgs;
      amount = kgs * 99;

      orderStatus.innerText = `‚úÖ ${kgs} kg ordered. Total amount: ‚Çπ${amount}`;
      orderStatus.className = "";

      document.getElementById("paymentNote").style.display = "block";
      payButton.style.display = "block";
    }

    function launchGPay(event) {
      event.preventDefault();
      const upiLink = `upi://pay?pa=9676213294@upi&pn=Sindhura%20Mangoes&am=${amount}&cu=INR&tn=Payment%20for%20${kgs}kg%20mango%20-%20Block%20${block}%20Flat%20${flat}`;
      window.location.href = upiLink;
    }

    function launchPhonePe(event) {
      event.preventDefault();
      const upiLink = `upi://pay?pa=9676213294@upi&pn=Sindhura%20Mangoes&am=${amount}&cu=INR&tn=Payment%20for%20${kgs}kg%20mango%20-%20Block%20${block}%20Flat%20${flat}`;
      window.location.href = upiLink;
    }

    async function confirmPayment() {
      const confirmStatus = document.getElementById("confirmStatus");

      if (!block || !flat) {
        confirmStatus.innerText = "‚ùå Please select both Block and Flat Number.";
        confirmStatus.className = "error";
        return;
      }

      const patchURL = `${SUPABASE_URL}/rest/v1/paymentinfo?block=eq.${block}&flat=eq.${flat}`;

      const res = await fetch(patchURL, {
        method: "PATCH",
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify({ paymentdone: true })
      });

      if (res.ok) {
        confirmStatus.innerText = "‚úÖ Thank you! Your payment has been confirmed.";
        confirmStatus.className = "";
      } else {
        confirmStatus.innerText = "‚ùå Error confirming payment. Please try again.";
        confirmStatus.className = "error";
      }
    }
  </script>
</body>
</html>
