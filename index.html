<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sindhura Mango Feedback</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #fff8ef;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    header {
      background-color: #ffd369;
      padding: 20px;
      text-align: center;
      border-radius: 0 0 20px 20px;
    }
    header h1 {
      margin: 0;
      color: #222;
    }
    .intro, .feedback-section, .payment-section {
      background: white;
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    h2 {
      margin-top: 0;
    }
    input, textarea, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
    }
    #status, #orderStatus, #confirmStatus {
      font-weight: bold;
      margin-top: 10px;
    }
    .error {
      color: red;
    }
    /* Specific button styles for better appearance */
    .btn-submit {
      background-color: #04aa6d;
    }
    .btn-gpay {
      background-color: #4285F4; /* Google Blue */
    }
    .btn-phonepe {
      background-color: #5e35b1; /* PhonePe Violet */
    }
    .btn-confirm {
      background-color: #04aa6d;
    }
  </style>
</head>
<body>
  <header class="p-5 text-center rounded-b-3xl bg-yellow-300">
    <h1 class="text-2xl font-bold text-gray-800">üçã Sindhura Mangoes ‚Äì A Taste of Tradition</h1>
  </header>
  <div class="container mx-auto px-4 py-5 max-w-xl">
    <div class="intro bg-white p-5 mt-5 rounded-xl shadow-md">
      <p class="text-gray-700">This weekend, we shared the rich flavor of <strong class="font-semibold">tree-ripened Sindhura mangoes</strong> ‚Äî naturally sweet, 100% pure, and chemical-free!</p>
      <p class="text-gray-700">üå≥ Grown in the fertile lands of <em>Palamaner Mandal, Chittoor District (Andhra Pradesh)</em>, these mangoes are ripened 85% on the tree for that signature juicy texture, vibrant red-yellow skin, and sweet-tangy taste.</p>
      <p class="text-gray-700"><strong class="font-semibold">The IVC family alone ordered over 100 KGs!</strong></p>
      <p class="text-gray-700">We hope you‚Äôve tasted and enjoyed them as much as we enjoyed delivering them to you. üôè</p>
      <p class="text-gray-700"><strong class="font-semibold">Please take a moment to share your feedback ‚Äî it means a lot to us!</strong></p>
    </div>

    <div class="feedback-section bg-white p-5 mt-5 rounded-xl shadow-md">
      <h2 class="text-xl font-semibold mb-4">üìù Share Your Feedback</h2>
      <input type="text" id="block" placeholder="Block (e.g., A)" required class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      <input type="text" id="flat" placeholder="Flat Number (e.g., 101)" required class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      <textarea id="feedback" placeholder="Your Feedback" required class="w-full p-2 mb-3 border border-gray-300 rounded-lg h-24 resize-y focus:outline-none focus:ring-2 focus:ring-yellow-300"></textarea>
      <button onclick="submitFeedback()" class="btn-submit w-full p-3 rounded-lg text-white font-medium hover:bg-green-700">Submit Feedback</button>
      <p id="status" class="text-sm mt-3"></p>
    </div>

    <div class="payment-section bg-white p-5 mt-5 rounded-xl shadow-md">
      <h2 class="text-xl font-semibold mb-4">üí∞ Make a Payment</h2>
      <label for="blockPay" class="block text-gray-700 text-sm font-medium mb-1">Select Block</label>
      <input type="text" id="blockPay" placeholder="Block (e.g., A)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      <label for="flatPay" class="block text-gray-700 text-sm font-medium mb-1">Select Flat Number</label>
      <input type="text" id="flatPay" placeholder="Flat Number (e.g., 101)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      <button onclick="calculatePayment()" class="btn-submit w-full p-3 rounded-lg text-white font-medium hover:bg-green-700">Check Due Amount</button>
      <p id="orderStatus" class="text-sm mt-3"></p>
      <p id="paymentNote" class="mt-3 italic text-gray-600" style="display:none;">üôè If you loved the mangoes, we'd be grateful for your support. You can make the payment below!</p>
      <div id="payButton" class="mt-4" style="display: none;">
        <a id="gpayLink" href="#" onclick="launchGPay(event)" class="block mb-2 no-underline">
          <button class="btn-gpay w-full p-3 rounded-lg text-white font-medium shadow-md hover:brightness-90">Pay Now via Google Pay</button>
        </a>
        <a id="phonepeLink" href="#" onclick="launchPhonePe(event)" class="block mb-2 no-underline">
          <button id="phonepeBtn" class="btn-phonepe w-full p-3 rounded-lg text-white font-medium shadow-md hover:brightness-90">Pay via PhonePe</button>
        </a>
        <p id="paymentInstructions" class="text-center text-sm text-gray-600 mt-2">
            After completing payment in your UPI app, please click '‚úÖ I Have Made the Payment' below.
        </p>
        <button onclick="confirmPayment()" class="btn-confirm w-full p-3 rounded-lg text-white font-medium shadow-md hover:bg-green-700 mt-2">‚úÖ I Have Made the Payment</button>
        <p id="confirmStatus" class="text-sm mt-3"></p>
      </div>
    </div>
  </div>

  <script>
    // Supabase URL and Anon Key - IMPORTANT: In a production environment,
    // these should be securely managed (e.g., environment variables, server-side).
    const SUPABASE_URL = "https://mqslfvseexirbrsxpuws.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xc2xmdnNlZXhpcmJyc3hwdXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDI4OTEsImV4cCI6MjA2NjMxODg5MX0.bSPcphsl_YOtv3_z07AjU-3BX6wiueW5_xan5KR2f-U";

    // Global variables to store payment details
    let amount = 0;
    let kgs = 0;
    let block = '';
    let flat = '';

    /**
     * Submits feedback to the Supabase database.
     * Fetches block, flat, and feedback text from input fields.
     * Displays success or error status to the user.
     */
    async function submitFeedback() {
      const blockInput = document.getElementById("block").value.trim();
      const flatInput = document.getElementById("flat").value.trim();
      const feedbackText = document.getElementById("feedback").value.trim();
      const statusElement = document.getElementById("status");

      // Basic validation for input fields
      if (!blockInput || !flatInput || !feedbackText) {
        statusElement.innerText = "‚ùå Please fill in all feedback fields.";
        statusElement.className = "error";
        return;
      }

      // Supabase URL for the 'feedback' table (assuming you have a 'feedback' table)
      const url = `${SUPABASE_URL}/rest/v1/feedback`; // Adjust table name if different

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            "Prefer": "return=minimal" // We don't need the returned data, just status
          },
          body: JSON.stringify({
            block: blockInput,
            flat: flatInput,
            feedback: feedbackText,
            timestamp: new Date().toISOString() // Add a timestamp for tracking
          })
        });

        if (response.ok) {
          statusElement.innerText = "‚úÖ Thank you for your feedback!";
          statusElement.className = "";
          // Clear form fields after successful submission
          document.getElementById("block").value = '';
          document.getElementById("flat").value = '';
          document.getElementById("feedback").value = '';
        } else {
          const errorData = await response.json();
          statusElement.innerText = `‚ùå Error submitting feedback: ${errorData.message || response.statusText}`;
          statusElement.className = "error";
          console.error("Feedback submission error:", errorData);
        }
      } catch (error) {
        statusElement.innerText = "‚ùå Network error. Please check your connection.";
        statusElement.className = "error";
        console.error("Feedback submission fetch error:", error);
      }
    }

    /**
     * Calculates the due payment amount based on block and flat number.
     * Fetches order information from Supabase.
     * Displays the amount and shows payment options if an order is found.
     */
    async function calculatePayment() {
      block = document.getElementById("blockPay").value.trim();
      flat = document.getElementById("flatPay").value.trim();
      const orderStatus = document.getElementById("orderStatus");
      const paymentNote = document.getElementById("paymentNote");
      const payButton = document.getElementById("payButton");
      const confirmStatus = document.getElementById("confirmStatus");
      const paymentInstructions = document.getElementById("paymentInstructions");


      // Reset previous status and hide payment options
      orderStatus.innerText = "";
      orderStatus.className = "";
      paymentNote.style.display = "none";
      payButton.style.display = "none";
      confirmStatus.innerText = ""; // Clear confirmation message
      paymentInstructions.style.display = "none"; // Hide instructions initially


      if (!block || !flat) {
        orderStatus.innerText = "‚ùå Please enter both Block and Flat Number.";
        orderStatus.className = "error";
        return;
      }

      const url = `${SUPABASE_URL}/rest/v1/orderInfo?block=eq.${block}&flat=eq.${flat}&select=kgs`;

      try {
        const res = await fetch(url, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        console.log("Order data received:", data);

        if (data.length === 0 || !data[0].kgs) {
          orderStatus.innerText = "‚ùå No mango order found for this flat. Please check Block/Flat Number.";
          orderStatus.className = "error";
          return;
        }

        kgs = data[0].kgs;
        amount = kgs * 99; // Assuming price is ‚Çπ99 per kg

        orderStatus.innerText = `‚úÖ ${kgs} kg ordered. Total amount due: ‚Çπ${amount}`;
        orderStatus.className = "";

        paymentNote.style.display = "block";
        payButton.style.display = "block";
        paymentInstructions.style.display = "block"; // Show instructions after amount is calculated
      } catch (error) {
        orderStatus.innerText = `‚ùå Error checking order: ${error.message}`;
        orderStatus.className = "error";
        console.error("Order check error:", error);
      }
    }

    /**
     * Launches Google Pay app with a pre-filled UPI payment link.
     * @param {Event} event - The click event from the button.
     */
    function launchGPay(event) {
      event.preventDefault(); // Prevent default link behavior

      if (amount <= 0 || !block || !flat) {
        document.getElementById("orderStatus").innerText = "‚ùå Please calculate the due amount first.";
        document.getElementById("orderStatus").className = "error";
        return;
      }

      // Replace with your actual UPI ID and Payee Name
      const payeeUPIId = "YOUR_GOOGLEPAY_UPI_ID@okicici"; // e.g., yourname@okicici, your_mobile_number@upi
      const payeeName = "Sindhura Mango Vendor";
      const transactionNote = `Mangoes for ${block}-${flat}`;

      const upiLink = `upi://pay?pa=${payeeUPIId}&pn=${encodeURIComponent(payeeName)}&am=${amount.toFixed(2)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;

      window.location.href = upiLink;
      console.log("Launching Google Pay with UPI link:", upiLink);

      // Inform the user to complete the payment in the UPI app
      document.getElementById("confirmStatus").innerText = "Redirecting to Google Pay. Please complete the payment there and then click 'I Have Made the Payment' here.";
      document.getElementById("confirmStatus").className = "";
    }

    /**
     * Launches PhonePe app with a pre-filled UPI payment link.
     * @param {Event} event - The click event from the button.
     */
    function launchPhonePe(event) {
      event.preventDefault(); // Prevent default link behavior

      if (amount <= 0 || !block || !flat) {
        document.getElementById("orderStatus").innerText = "‚ùå Please calculate the due amount first.";
        document.getElementById("orderStatus").className = "error";
        return;
      }

      // Replace with your actual UPI ID and Payee Name
      const payeeUPIId = "YOUR_PHONEPE_UPI_ID@ybl"; // e.g., yourname@ybl, your_mobile_number@ybl
      const payeeName = "Sindhura Mango Vendor";
      const transactionNote = `Mangoes for ${block}-${flat}`;

      const upiLink = `upi://pay?pa=${payeeUPIId}&pn=${encodeURIComponent(payeeName)}&am=${amount.toFixed(2)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;

      window.location.href = upiLink;
      console.log("Launching PhonePe with UPI link:", upiLink);

      // Inform the user to complete the payment in the UPI app
      document.getElementById("confirmStatus").innerText = "Redirecting to PhonePe. Please complete the payment there and then click 'I Have Made the Payment' here.";
      document.getElementById("confirmStatus").className = "";
    }

    /**
     * Confirms that the user has made the payment and updates the Supabase database.
     * This function is called by the user after they manually complete the UPI payment.
     */
    async function confirmPayment() {
      const confirmStatus = document.getElementById("confirmStatus");

      if (amount <= 0 || !block || !flat) {
        confirmStatus.innerText = "‚ùå Please calculate the due amount and initiate payment first.";
        confirmStatus.className = "error";
        return;
      }

      // Supabase URL for the 'paymentinfo' table
      const patchURL = `${SUPABASE_URL}/rest/v1/paymentinfo?block=eq.${block}&flat=eq.${flat}`;

      try {
        const res = await fetch(patchURL, {
          method: "PATCH",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            "Prefer": "return=minimal" // We don't need the returned data, just status
          },
          body: JSON.stringify({
            paymentdone: true,
            payment_status: 'completed', // New field to indicate payment status
            payment_confirmed_at: new Date().toISOString()
          })
        });

        if (res.ok) {
          confirmStatus.innerText = "‚úÖ Thank you! Your payment confirmation has been recorded.";
          confirmStatus.className = "";
          // Hide payment sections and clear inputs after successful confirmation
          document.getElementById("payButton").style.display = "none";
          document.getElementById("paymentNote").style.display = "none";
          document.getElementById("paymentInstructions").style.display = "none";
          document.getElementById("orderStatus").innerText = "";
          document.getElementById("blockPay").value = '';
          document.getElementById("flatPay").value = '';
          // Reset global variables
          amount = 0;
          kgs = 0;
          block = '';
          flat = '';
        } else {
          const errorData = await res.json();
          confirmStatus.innerText = `‚ùå Error confirming payment: ${errorData.message || res.statusText}`;
          confirmStatus.className = "error";
          console.error("Payment confirmation error:", errorData);
        }
      } catch (error) {
        confirmStatus.innerText = "‚ùå Network error. Could not confirm payment.";
        confirmStatus.className = "error";
        console.error("Payment confirmation fetch error:", error);
      }
    }
  </script>
</body>
</html>
